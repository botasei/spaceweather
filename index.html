<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ–≥–Ω–æ–∑ –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –ò–Ω—Å—Ç–∏—Ç—É—Ç –∏–æ–Ω–æ—Å—Ñ–µ—Ä—ã</title>

<style>
    /* ======== –û–ë–©–ò–ô –°–¢–ò–õ–¨, –ú–ê–¢–û–í–´–ô –ß–Å–†–ù–´–ô ======== */
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        color: #f0f0f0;
        background-color: #050608; /* –º—è–≥–∫–∏–π –º–∞—Ç–æ–≤—ã–π —á—ë—Ä–Ω—ã–π */
    }

    .page-wrapper {
        min-height: 100vh;
        background: #050608;
        padding-bottom: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 10px;
    }

    /* ---------- –®–ê–ü–ö–ê ---------- */
    .header {
        width: 1100px;
        margin: 0 auto;
        padding: 15px 0 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .logo-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .logo-group img {
        height: 75px;
        object-fit: contain;
    }

    .header-title {
        text-align: center;
        flex: 1;
        padding: 0 20px;
    }

    .header-title h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.5px;
        color: #ffffff;
    }

    .header-title p {
        font-size: 12px;
        margin: 2px 0 0;
        color: #cccccc;
    }

    /* ---------- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ---------- */
    .main-wrapper {
        width: 1100px;
        margin: 0 auto;
        background: #07090c;
        border-radius: 10px;
        padding: 15px 20px 20px;
        border: 1px solid rgba(255,255,255,0.15);
    }

    .title {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: bold;
        color: #ffffff;
    }

    .content-row {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 16px;
    }

    .panel {
        background: #050608;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.18);
        padding: 15px;
    }

    .panel-wide   { flex: 1.6; }
    .panel-narrow { flex: 1.0; }

    .panel-bottom {
        width: 100%;
        margin-top: 24px;
    }

    .panel h2 {
        margin: 0 0 4px;
        font-size: 18px;
        text-align: center;
        color: #ffffff;
    }

    .panel small {
        display: block;
        text-align: left;
        font-size: 11px;
        margin-bottom: 4px;
        color: #cccccc;
    }

    /* ---------- –ì–†–ê–§–ò–ö–ò ---------- */
    #kpChart {
        width: 100%;
        height: 480px !important;
        background-color: #050608;
    }

    #almaKChart {
        width: 100%;
        height: 260px !important;
        background-color: #050608;
    }

    .last-update {
        font-size: 11px;
        margin-top: 6px;
        text-align: left;
        color: #cccccc;
    }

    .status-box {
        margin-top: 10px;
        padding: 14px 16px;
        border-radius: 10px;
        background: #050608;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .status-box h2 {
        margin: 0 0 8px;
        font-size: 15px;
        text-align: center;
        color: #ffffff;
    }

    .status-box p {
        margin: 0;
        font-size: 13px;
        line-height: 1.4;
        text-align: justify;
        color: #dddddd;
    }

    .export-buttons {
        margin-top: 6px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .export-buttons button {
        background: #2e2e33;
        color: #ffffff;
        border-radius: 6px;
        border: 1px solid #777;
        padding: 4px 10px;
        font-size: 11px;
        cursor: pointer;
    }

    .export-buttons button:hover {
        background: #44444a;
    }

    /* ---------- –õ–ï–ì–ï–ù–î–ê –°–û–°–¢–û–Ø–ù–ò–ô Kp ---------- */
    .kp-label {
        font-weight: bold;
        text-align: center;
        margin: 6px 0 8px;
        font-size: 13px;
        color: #ffffff;
    }

    .legend-block {
        margin-top: 4px;
        font-size: 12px;
        line-height: 1.4;
        color: #dddddd;
    }

    .legend-row {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border: 1px solid #000;
        margin-right: 6px;
        border-radius: 3px;
    }

    .kp-low    { background: #00b050; }
    .kp-yellow { background: #ffd800; }
    .kp-red1   { background: #ff3b3b; }
    .kp-red2   { background: #e00000; }
    .kp-red3   { background: #b00000; }
    .kp-red4   { background: #800000; }

    /* ---------- –ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ UT ---------- */
    .ut-description {
        margin-top: 10px;
        font-size: 12px;
        line-height: 1.4;
        color: #cccccc;
        text-align: left;
    }
    .ut-description strong {
        color: #ffffff;
    }

    /* ---------- –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---------- */
    .admin-toggle {
        width: 1100px;
        margin-top: 8px;
        text-align: right;
    }

    .admin-toggle button {
        background: #2e2e33;
        color: #fff;
        border-radius: 6px;
        border: 1px solid #777;
        padding: 4px 10px;
        font-size: 11px;
        cursor: pointer;
    }

    .admin-panel {
        width: 1100px;
        margin: 10px auto 15px;
        padding: 15px 20px;
        background: #050608;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.18);
        font-size: 12px;
        display: none;
        color: #f0f0f0;
    }

    .admin-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px 15px;
        margin-bottom: 10px;
    }

    .admin-panel input,
    .admin-panel textarea {
        width: 100%;
        border-radius: 5px;
        border: 1px solid #ccc;
        padding: 5px;
        font-size: 12px;
        background: #0c0f13;
        color: #f0f0f0;
    }

    .btn-save {
        background: #0b7c2f;
        color: #fff;
        border-radius: 6px;
        border: 1px solid #0b7c2f;
        padding: 4px 10px;
        cursor: pointer;
    }

    .btn-reset {
        background: #8b0000;
        color: #fff;
        border-radius: 6px;
        border: 1px solid #8b0000;
        padding: 4px 10px;
        cursor: pointer;
        margin-right: 8px;
    }

    .admin-actions {
        margin-top: 10px;
        text-align: right;
    }
</style>
</head>
<body>
<div class="page-wrapper">

    <!-- ---------- –®–ê–ü–ö–ê ---------- -->
    <div class="header">
        <div class="logo-group">
            <img src="ii_logo_en.png" alt="–ò–Ω—Å—Ç–∏—Ç—É—Ç –∏–æ–Ω–æ—Å—Ñ–µ—Ä—ã">
        </div>

        <div class="header-title">
            <h1>–ò–Ω—Å—Ç–∏—Ç—É—Ç –∏–æ–Ω–æ—Å—Ñ–µ—Ä—ã, –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</h1>
            <p>–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –ø–æ–≥–æ–¥—ã</p>
        </div>

        <div class="logo-group">
            <img src="banner_lab.png" alt="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –ø–æ–≥–æ–¥—ã">
        </div>
    </div>

    <!-- ---------- –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö ---------- -->
    <div class="main-wrapper">
        <div class="title">–ü—Ä–æ–≥–Ω–æ–∑ –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 6 –¥–Ω–µ–π.</div>

        <div class="content-row">
            <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ü–†–û–ì–ù–û–ó Kp -->
            <div class="panel panel-wide">
                <small>Kp-index</small>

                <canvas id="kpChart"></canvas>

                <div class="export-buttons">
                    <button onclick="downloadPNG('kpChart','kp_forecast.png')">PNG</button>
                </div>

                <div class="last-update">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">‚Äì</span>
                </div>

                <div class="status-box">
                    <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–æ–ª–æ–∑–µ–º–Ω–æ–≥–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</h2>
                    <p id="status-text">
                        –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 6 –¥–Ω–µ–π. –î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                        –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –ø–æ–≥–æ–¥—ã –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞ –∏–æ–Ω–æ—Å—Ñ–µ—Ä—ã.
                    </p>
                </div>
            </div>

            <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–û–°–¢–û–Ø–ù–ò–ï –ú–ê–ì–ù–ò–¢–ù–û–ì–û –ü–û–õ–Ø + –õ–ï–ì–ï–ù–î–ê -->
            <div class="panel panel-narrow">
                <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞–≥–Ω–∏—Ç–Ω–æ–≥–æ –ø–æ–ª—è</h2>
                <small>Kp-index (–ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å)</small>

                <div class="kp-label">–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∏–Ω–¥–µ–∫—Å–∞ Kp</div>

                <div class="legend-block">
                    <div class="legend-row">
                        <div class="legend-color kp-low"></div>
                        –°–ø–æ–∫–æ–π–Ω–æ–µ / —Å–ª–∞–±–æ–≤–æ–∑–º—É—â–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Kp = 0‚Äì3)
                    </div>
                    <div class="legend-row">
                        <div class="legend-color kp-yellow"></div>
                        –í–æ–∑–º—É—â–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Kp = 4)
                    </div>
                    <div class="legend-row">
                        <div class="legend-color kp-red1"></div>
                        –ú–∞–ª–∞—è –º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è (Kp = 5)
                    </div>
                    <div class="legend-row">
                        <div class="legend-color kp-red2"></div>
                        –£–º–µ—Ä–µ–Ω–Ω–∞—è –º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è (Kp = 6)
                    </div>
                    <div class="legend-row">
                        <div class="legend-color kp-red3"></div>
                        –ë–æ–ª—å—à–∞—è –º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è (Kp = 7)
                    </div>
                    <div class="legend-row">
                        <div class="legend-color kp-red4"></div>
                        –û—á–µ–Ω—å –±–æ–ª—å—à–∞—è / —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è (Kp = 8‚Äì9)
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–ò–ñ–ù–ò–ô –ì–†–ê–§–ò–ö: –¢–ï–ö–£–©–ò–ï K-–ò–ù–î–ï–ö–°–´ –ê–õ–ú–ê-–ê–¢–ê -->
        <div class="panel panel-bottom">
            <h2>–¢–µ–∫—É—â–∏–µ 3-—á–∞—Å–æ–≤—ã–µ K-–∏–Ω–¥–µ–∫—Å—ã</h2>
            <small>–ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è ¬´–ê–ª–º–∞-–ê—Ç–∞¬ª</small>
<canvas id="almaKChart"></canvas>

<div class="ut-description">
    <p>
        <strong>UT (Universal Time)</strong> ‚Äì –º–∏—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π. <br>
        <span style="color:#bbbbbb">ALM/GMT+5 ‚Äì –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏ –ê–ª–º–∞-–ê—Ç–∞.</span>
    </p>
</div>

<!-- üëá –í–°–¢–ê–í–õ–Ø–ï–ú –æ–ø–∏—Å–∞–Ω–∏–µ –°–†–ê–ó–£ –ü–û–°–õ–ï UT -->
<div class="ut-description">
    <p>
        –ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è ¬´–ê–ª–º–∞-–ê—Ç–∞¬ª —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∞ –≤ –ø—Ä–µ–¥–≥–æ—Ä—å—è—Ö –°–µ–≤–µ—Ä–Ω–æ–≥–æ –¢—è–Ω—å-–®–∞–Ω—è –Ω–∞ –≤—ã—Å–æ—Ç–µ –æ–∫–æ–ª–æ 1300 –º –Ω–∞–¥ —É—Ä–æ–≤–Ω–µ–º –º–æ—Ä—è, –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 10 –∫–º –æ—Ç –≥–æ—Ä–æ–¥–∞ –ê–ª–º–∞—Ç—ã.
        –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏: 43,10¬∞ —Å. —à. –∏ 76,57¬∞ –≤. –¥., –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 34,3¬∞ —Å. —à. –∏ 152,7¬∞ –≤. –¥.
        –ù–∞ –±–∞–∑–µ –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–≥–æ –ø–æ–ª—è.
    </p>
</div>

<div class="export-buttons">
    <button onclick="downloadPNG('almaKChart','almata_k3h.png')">PNG</button>
</div>

<div class="last-update">
    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: <span id="alma-last-update"></span>
</div>


        </div>
    </div>

    <!-- –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–ì–ù–û–ó–ê -->
    <div class="admin-toggle">
        <button id="toggle-admin">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
    </div>

    <div class="admin-panel" id="admin-panel">
        <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞</h3>

        <div class="admin-grid">
            <div><label>–î–∞—Ç–∞ 1</label><input id="date-0"></div>
            <div><label>Kp 1</label><input id="kp-0" type="number" min="0" max="9"></div><div></div>

            <div><label>–î–∞—Ç–∞ 2</label><input id="date-1"></div>
            <div><label>Kp 2</label><input id="kp-1" type="number" min="0" max="9"></div><div></div>

            <div><label>–î–∞—Ç–∞ 3</label><input id="date-2"></div>
            <div><label>Kp 3</label><input id="kp-2" type="number" min="0" max="9"></div><div></div>

            <div><label>–î–∞—Ç–∞ 4</label><input id="date-3"></div>
            <div><label>Kp 4</label><input id="kp-3" type="number" min="0" max="9"></div><div></div>

            <div><label>–î–∞—Ç–∞ 5</label><input id="date-4"></div>
            <div><label>Kp 5</label><input id="kp-4" type="number" min="0" max="9"></div><div></div>

            <div><label>–î–∞—Ç–∞ 6</label><input id="date-5"></div>
            <div><label>Kp 6</label><input id="kp-5" type="number" min="0" max="9"></div><div></div>
        </div>

        <label>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
        <input id="form-last-update">

        <label>–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
        <textarea id="form-status-text"></textarea>

        <div class="admin-actions">
            <button class="btn-reset" id="btn-reset">–°–±—Ä–æ—Å</button>
            <button class="btn-save" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ================= */

const STORAGE_KEY = "swKpForecast_v3";

function pad2(n) { return n < 10 ? "0" + n : "" + n; }

function formatNowUtc() {
    const d = new Date();
    return pad2(d.getUTCDate()) + "." +
           pad2(d.getUTCMonth() + 1) + "." +
           d.getUTCFullYear() + " " +
           pad2(d.getUTCHours()) + ":" +
           pad2(d.getUTCMinutes()) + " UT";
}

/* 6 –¥–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞: —Å–µ–≥–æ–¥–Ω—è + 0‚Ä¶5 –¥–Ω–µ–π, —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY */
function generateForecastDates() {
    const today = new Date();
    const dates = [];
    for (let i = 0; i < 6; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        dates.push(pad2(d.getDate()) + "." + pad2(d.getMonth() + 1) + "." + d.getFullYear());
    }
    return dates;
}

/* —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X –Ω–∏–∂–Ω–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞: "21 Nov" */
function formatDateShort(datePart) {
    const [yyyy, mm, dd] = datePart.split("-");
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const mIdx = parseInt(mm, 10) - 1;
    const day = parseInt(dd, 10);
    const monthLabel = months[mIdx] || mm;
    return `${day} ${monthLabel}`;
}

/* —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–Ω–æ–≥–æ Kp (–≤–µ—Ä—Ö–Ω–∏–π –≥—Ä–∞—Ñ–∏–∫) */
function kpColor(kp) {
    if (kp <= 3) return "#00b050";   // —Å–ø–æ–∫–æ–π–Ω–æ–µ / —Å–ª–∞–±–æ–≤–æ–∑–º—É—â—ë–Ω–Ω–æ–µ
    if (kp === 4) return "#ffd800";  // –≤–æ–∑–º—É—â—ë–Ω–Ω–æ–µ
    if (kp === 5) return "#ff3b3b";  // —Å–ª–∞–±–∞—è –±—É—Ä—è
    if (kp === 6) return "#e00000";  // —É–º–µ—Ä–µ–Ω–Ω–∞—è –±—É—Ä—è
    if (kp === 7) return "#b00000";  // –±–æ–ª—å—à–∞—è –±—É—Ä—è
    return "#800000";                // –æ—á–µ–Ω—å –±–æ–ª—å—à–∞—è / —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è (8‚Äì9)
}

/* —Ü–≤–µ—Ç–∞ –≤ —Å—Ç–∏–ª–µ Potsdam –¥–ª—è –Ω–∞–±–ª—é–¥—ë–Ω–Ω—ã—Ö K */
function gfzKColor(kp) {
    if (kp <= 0) return "#0000ff";      // 0 ‚Äî —Å–∏–Ω–∏–π
    if (kp <= 3) return "#00ff00";      // 1‚Äì3 ‚Äî —è—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π
    if (kp === 4) return "#ffff00";     // 4 ‚Äî –∂—ë–ª—Ç—ã–π
    if (kp <= 6) return "#ff9900";      // 5‚Äì6 ‚Äî –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    return "#ff0000";                   // 7‚Äì9 ‚Äî –∫—Ä–∞—Å–Ω—ã–π
}

/* ================= –ü–†–û–ì–ù–û–ó–ù–´–ô –ì–†–ê–§–ò–ö KP ================= */

const defaultData = {
    dates: generateForecastDates(),
    kp:    [1, 2, 4, 6, 7, 8],
    lastUpdate: "",
    statusText: "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 6 –¥–Ω–µ–π. –î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –ø–æ–≥–æ–¥—ã –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞ –∏–æ–Ω–æ—Å—Ñ–µ—Ä—ã."
};

function loadData() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultData;
        const parsed = JSON.parse(raw);
        if (!parsed.dates || !parsed.kp) return defaultData;
        return parsed;
    } catch {
        return defaultData;
    }
}

function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

let kpChartInstance = null;

/* –ø–ª–∞–≥–∏–Ω ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è Kp –≤–Ω—É—Ç—Ä–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–≤–µ—Ä—Ö–Ω–∏–π –≥—Ä–∞—Ñ–∏–∫) */
const valueLabelPlugin = {
    id: "valueLabel",
    afterDatasetsDraw(chart) {
        if (!chart.canvas || chart.canvas.id !== "kpChart") return;

        const { ctx } = chart;
        const dataset = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);

        ctx.save();
        ctx.font = "bold 16px Arial";
        ctx.fillStyle = "#ffffff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        meta.data.forEach((bar, index) => {
            const val = dataset.data[index];
            if (val == null) return;

            const props = bar.getProps(["x", "y", "base"], true);
            const x = props.x;
            const y = props.y;
            const base = props.base;
            const centerY = y + (base - y) / 2;

            ctx.fillText(val, x, centerY);
        });

        ctx.restore();
    }
};

Chart.register(valueLabelPlugin);

function renderKpChart(data) {
    const ctx = document.getElementById("kpChart").getContext("2d");
    if (kpChartInstance) kpChartInstance.destroy();

    const colors = data.kp.map(kpColor);

    kpChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: data.dates,
            datasets: [{
                data: data.kp,
                backgroundColor: colors,
                borderColor: "#000000",
                borderWidth: 1.4,
                barThickness: "flex",
                barPercentage: 0.95,
                categoryPercentage: 0.98,
                borderRadius: 3
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            layout: { padding: { top: 20, right: 10, left: 0, bottom: 10 } },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 9,
                    ticks: { stepSize: 1, color: "#ffffff", font: { size: 13 } },
                    grid: { color: "rgba(255,255,255,0.25)" },
                    title: {
                        display: true,
                        text: "Kp-index",
                        color: "#ffffff",
                        font: { size: 14 }
                    }
                },
                x: {
                    ticks: { color: "#ffffff", font: { size: 11 } },
                    grid: { display: false },
                    title: {
                        display: true,
                        text: "–î–∞—Ç–∞",
                        color: "#ffffff",
                        font: { size: 13 }
                    }
                }
            }
        }
    });

    document.getElementById("last-update").textContent =
        data.lastUpdate || formatNowUtc();
    document.getElementById("status-text").textContent =
        data.statusText || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.";
}

/* ---------- –§–û–†–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–ì–ù–û–ó–ê ---------- */

function fillForm(data) {
    for (let i = 0; i < 6; i++) {
        document.getElementById("date-" + i).value = data.dates[i] || "";
        document.getElementById("kp-" + i).value   = data.kp[i] ?? "";
    }
    document.getElementById("form-last-update").value = data.lastUpdate || "";
    document.getElementById("form-status-text").value = data.statusText || "";
}

function readForm() {
    const dates = [];
    const kp = [];
    for (let i = 0; i < 6; i++) {
        dates.push(document.getElementById("date-" + i).value || "");
        const val = Number(document.getElementById("kp-" + i).value);
        kp.push(Number.isNaN(val) ? 0 : val);
    }
    return {
        dates,
        kp,
        lastUpdate: document.getElementById("form-last-update").value || "",
        statusText: document.getElementById("form-status-text").value || ""
    };
}

/* –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
function autoFillDates() {
    const dates = generateForecastDates();
    for (let i = 0; i < 6; i++) {
        document.getElementById("date-" + i).value = dates[i];
    }
}

document.getElementById("toggle-admin").onclick = () => {
    const p = document.getElementById("admin-panel");
    const isOpening = (p.style.display !== "block");
    p.style.display = isOpening ? "block" : "none";

    if (isOpening) {
        autoFillDates();
    }
};

document.getElementById("btn-save").onclick = () => {
    const data = readForm();
    data.lastUpdate = formatNowUtc();
    document.getElementById("form-last-update").value = data.lastUpdate;
    saveData(data);
    renderKpChart(data);

    document.getElementById("admin-panel").style.display = "none";
    setTimeout(() => location.reload(), 100);
};

document.getElementById("btn-reset").onclick = () => {
    const data = {
        ...defaultData,
        dates: generateForecastDates(),
        lastUpdate: formatNowUtc()
    };
    saveData(data);
    fillForm(data);
    renderKpChart(data);
};

/* ================= 3-–ß–ê–°–û–í–´–ï K-–ò–ù–î–ï–ö–°–´ –ê–õ–ú–ê-–ê–¢–ê ================= */

let almaChartInstance = null;

function renderAlmaKChart(labels, values) {
    const ctx = document.getElementById("almaKChart").getContext("2d");
    if (almaChartInstance) almaChartInstance.destroy();

    almaChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: values.map(gfzKColor),
                borderColor: "#444444",
                borderWidth: 1,
                barThickness: "flex",
                barPercentage: 0.95,
                categoryPercentage: 1.0,
                borderRadius: 0
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 9,
                    ticks: {
                        stepSize: 1,
                        color: "#f0f0f0",
                        font: { size: 13 }
                    },
                    grid: {
                        color: "rgba(255,255,255,0.12)"
                    },
                    title: {
                        display: true,
                        text: "K-index",
                        color: "#f0f0f0",
                        font: { size: 15 }
                    }
                },
                x: {
                    ticks: {
                        color: "#f0f0f0",
                        font: { size: 14 },
                        autoSkip: false,
                        maxRotation: 0,
                        minRotation: 0,
                        callback: function (value, index, ticks) {
                            const raw = this.getLabelForValue(value); // "YYYY-MM-DD HH:MM:SS"
                            if (!raw) return "";
                            const [datePart, timePartFull] = raw.split(" ");
                            const time = timePartFull ? timePartFull.slice(0, 5) : "";

                            if (index === 0) {
                                return formatDateShort(datePart) + "\n" + time;
                            }
                            const prevRaw = this.getLabelForValue(ticks[index - 1].value);
                            const prevDatePart = prevRaw ? prevRaw.split(" ")[0] : null;

                            if (prevDatePart === datePart) {
                                return time; // —Ç–∞ –∂–µ –¥–∞—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è
                            } else {
                                return formatDateShort(datePart) + "\n" + time; // –Ω–æ–≤–∞—è –¥–∞—Ç–∞
                            }
                        }
                    },
                    grid: { display: false },
                    title: {
                        display: true,
                        text: "–í—Ä–µ–º—è (UT)",
                        color: "#f0f0f0",
                        font: { size: 14 }
                    }
                }
            }
        }
    });

    if (labels.length) {
        const lastRaw = labels[labels.length - 1];   // "YYYY-MM-DD HH:MM:SS"
        const [datePart, timePartFull] = lastRaw.split(" ");
        const time = timePartFull ? timePartFull.slice(0, 5) : "";
        document.getElementById("alma-last-update").textContent =
            formatDateShort(datePart) + " " + time + " UT";
    } else {
        document.getElementById("alma-last-update").textContent = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
    }
}

/* –ß—Ç–µ–Ω–∏–µ k-index.txt –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞.
   –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: "YYYY-MM-DD HH:MM:SS,value" –ø–æ —Å—Ç—Ä–æ–∫–∞–º. */
async function loadAlmaDataFromTxt() {
    try {
        const resp = await fetch("k-index.txt", { cache: "no-store" });
        if (!resp.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å k-index.txt: " + resp.status);

        const text = await resp.text();
        const lines = text.trim().split(/\r?\n/);

        const fullLabels = [];
        const fullValues = [];

        for (const raw of lines) {
            const line = raw.trim();
            if (!line) continue;

            const parts = line.split(",");
            if (parts.length < 2) continue;

            const dtStr  = parts[0].trim(); // "2025-11-19 00:00:00"
            const valStr = parts[1].trim(); // "0", "1", "-1"
            const val = parseFloat(valStr);

            if (isNaN(val) || val < 0) continue; // –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (-1)

            fullLabels.push(dtStr);
            fullValues.push(val);
        }

        if (!fullValues.length) {
            throw new Error("k-index.txt: –Ω–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π K-–∏–Ω–¥–µ–∫—Å–∞");
        }

        // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Ç–æ—á–µ–∫
        const N = 12;
        const start = Math.max(0, fullLabels.length - N);
        const labels = fullLabels.slice(start);
        const values = fullValues.slice(start);

        renderAlmaKChart(labels, values);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏/–æ–±—Ä–∞–±–æ—Ç–∫–∏ k-index.txt:", e);
        document.getElementById("alma-last-update").textContent =
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
    }
}

/* ================= –≠–ö–°–ü–û–†–¢ –í PNG ================= */

function downloadPNG(canvasId, fileName) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = fileName || (canvasId + ".png");
    link.click();
}

/* ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ ================= */

const initialData = loadData();
if (!initialData.lastUpdate) initialData.lastUpdate = formatNowUtc();
fillForm(initialData);
renderKpChart(initialData);

loadAlmaDataFromTxt();   // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ k-index.txt
// setInterval(loadAlmaDataFromTxt, 5 * 60 * 1000); // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
</script>
</body>
</html>






<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Архив прогнозов — Институт ионосферы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    :root{
      --page-max-width: 1700px;

      /* Glass */
      --glass-bg: rgba(10, 15, 25, 0.28);
      --glass-border: rgba(255,255,255,0.22);
      --glass-blur: 12px;
      --glass-shadow: 0 8px 30px rgba(0,0,0,0.25);

      /* фон */
      --bg-dim: rgba(0,0,0,0.33);
    }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:#f0f0f0;
      font-size:18px;

      background-image:url("background_sun.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bg-dim);
      z-index:-1;
    }

    .page-wrapper{
      min-height:100vh;
      padding:10px 0 40px;
      display:flex;
      flex-direction:column;
      align-items:center;

      position:relative;
      z-index:1;
      background:transparent;
    }

    /* glass */
    .header,
    .main-wrapper,
    .panel{
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    /* читаемость */
    h1,h2,h3,p,small,.title,.muted{
      text-shadow:0 0 8px rgba(0,0,0,0.55);
    }

    /* ---------- ШАПКА ---------- */
    .header{
      width:90vw;
      max-width:var(--page-max-width);
      margin:0 auto;
      padding:15px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-sizing:border-box;
      border-radius:12px;
      gap:12px;
    }

    .logo-group{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
    }
    .logo-group img{
      height:78px;
      object-fit:contain;
    }

    .header-title{
      text-align:center;
      flex:1;
      padding:0 10px;
    }
    .header-title h1{
      font-size:40px;
      margin:0;
      letter-spacing:0.3px;
      color:#fff;
      line-height:1.25;
    }
    .header-title p{
      font-size:20px;
      margin:8px 0 0;
      color:#e0e0e0;
    }

    /* ---------- ОСНОВНОЙ КОНТЕЙНЕР ---------- */
    .main-wrapper{
      width:90vw;
      max-width:var(--page-max-width);
      margin:14px auto 0;
      border-radius:12px;
      padding:18px 18px 22px;
      box-sizing:border-box;
    }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .title{
      font-size:34px;
      margin:0;
      font-weight:bold;
      color:#fff;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      background:rgba(255,255,255,0.12);
      color:#fff;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.28);
      padding:8px 14px;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ background:rgba(255,255,255,0.18); }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }

    .panel{
      border-radius:12px;
      padding:14px;
      box-sizing:border-box;
    }

    .panel h2{
      margin:0 0 10px;
      font-size:24px;
      color:#fff;
      text-align:left;
    }

    .muted{
      color:#e6e6e6;
      font-size:14px;
      margin:6px 0 10px;
      opacity:0.95;
    }

    /* поиск + список */
    .search-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .input{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.25);
      padding:10px 12px;
      font-size:16px;
      background:rgba(0,0,0,0.35);
      color:#f0f0f0;
      box-sizing:border-box;
      outline:none;
    }
    .input:focus{ border-color:rgba(255,255,255,0.45); }

    .dates{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:520px;
      overflow:auto;
      padding-right:4px;
    }

    .date-btn{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      font-size:16px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
    }
    .date-btn:hover{ background:rgba(255,255,255,0.12); }
    .date-btn.active{
      background:rgba(255,255,255,0.18);
      border-color:rgba(255,255,255,0.35);
      transform: translateY(-1px);
    }

    /* просмотр */
    .kv-line{
      font-size:18px;
      margin:8px 0;
      color:#f0f0f0;
      line-height:1.5;
    }

    .box{
      margin-top:10px;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px;
      padding:12px;
    }

    details{ margin-top:12px; }
    summary{
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      user-select:none;
    }
    pre{
      margin-top:10px;
      background:rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.18);
      padding:12px;
      border-radius:12px;
      overflow:auto;
      color:#f0f0f0;
      font-size:14px;
    }

    .status{
      white-space:pre-wrap;
      line-height:1.7;
      font-size:18px;
      color:#f0f0f0;
    }

    .empty{
      padding:10px 0;
      color:#e6e6e6;
      font-size:16px;
    }

    /* ---------- KP ЧИПЫ + MAX BADGE ---------- */
    .kp-summary{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .kp-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(255,255,255,0.10);
      font-size:14px;
      color:#fff;
      white-space:nowrap;
    }
    .kp-badge .dot{
      width:10px; height:10px; border-radius:50%;
      border:1px solid rgba(0,0,0,0.55);
      display:inline-block;
    }

    .kp-chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .kp-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.18);
      color:#fff;
      font-size:14px;
      white-space:nowrap;
    }

    .kp-chip .tag{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.55);
      color:#fff;
      font-weight:bold;
      min-width:28px;
      text-align:center;
    }

    .kp0_3{ background:#00b050; }
    .kp4{ background:#ffd800; color:#000; border-color: rgba(0,0,0,0.35); }
    .kp5{ background:#ff3b3b; }
    .kp6{ background:#e00000; }
    .kp7{ background:#b00000; }
    .kp8_9{ background:#800000; }

    /* ---------- FADE IN ---------- */
    @keyframes fadeInUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .fade-in{
      animation: fadeInUp 420ms ease-out both;
    }

    @media (max-width:1100px){
      .grid{ grid-template-columns: 1fr; }
      .dates{ max-height:280px; }
      .header-title h1{ font-size:32px; }
      .header-title p{ font-size:18px; }
      .title{ font-size:28px; }
      .logo-group img{ height:64px; }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">

    <!-- ШАПКА -->
    <div class="header">
      <div class="logo-group">
        <img src="ii_logo_en.png" alt="Институт ионосферы">
      </div>

      <div class="header-title">
        <h1>Институт ионосферы, Алматы, Казахстан</h1>
        <p>Лаборатория диагностики и прогноза космической погоды</p>
      </div>

      <div class="logo-group" style="justify-content:flex-end;">
        <img src="banner_lab.png" alt="Лаборатория космической погоды">
      </div>
    </div>

    <!-- КОНТЕНТ -->
    <div class="main-wrapper">
      <div class="top-row">
        <h2 class="title">Архив прогнозов</h2>

        <div class="actions">
          <a class="btn" href="index.html">← На главную</a>
          <button class="btn" id="btn-clear">Очистить поиск</button>
        </div>
      </div>

      <div class="grid">
        <!-- левый блок -->
        <div class="panel">
          <h2>Поиск по дате</h2>
          <p class="muted">Формат: <b>YYYY-MM-DD</b> (например: 2026-02-20). Можно вводить часть даты.</p>

          <div class="search-wrap">
            <input class="input" id="search" placeholder="Введите дату (например 2026-02-20)"/>
          </div>

          <div class="muted" id="count">Загрузка списка…</div>
          <div class="dates" id="dates"></div>
          <div class="empty" id="empty" style="display:none;">Нет совпадений по поиску.</div>
        </div>

        <!-- правый блок -->
        <div class="panel">
          <h2 id="view-title">Выберите дату слева</h2>

          <div id="view" style="display:none;">
            <div class="kv-line"><b>Последнее обновление:</b> <span id="lu">—</span></div>

            <!-- ✅ чипы и max kp -->
            <div class="kv-line" style="margin-bottom:6px;"><b>Kp (6 дней):</b></div>
            <div class="kp-summary">
              <div class="kp-chips" id="kp-chips"></div>
              <div class="kp-badge" id="kp-badge" style="display:none;">
                <span class="dot" id="kp-badge-dot"></span>
                <span><b>max Kp:</b> <span id="kp-max">—</span></span>
              </div>
            </div>

            <!-- (оставим старую строку, но спрячем — на всякий случай) -->
            <div class="kv-line" id="kp-old" style="display:none;"><b>Kp (6 дней):</b> <span id="kp">—</span></div>

            <div class="box">
              <h3 style="margin:0 0 8px;">Состояние околоземного космического пространства</h3>
              <div class="status" id="st">—</div>
            </div>

            <details>
              <summary>Показать сырой JSON</summary>
              <pre id="raw"></pre>
            </details>
          </div>

          <div class="muted" id="msg">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_LIST = "/api/archive";
  const API_ONE  = (d) => "/api/archive?date=" + encodeURIComponent(d);

  let ALL_DATES = [];

  async function fetchJSON(url){
    const r = await fetch(url, { cache: "no-store" });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || "Request failed");
    return j;
  }

  function setMsg(text){
    const msg = document.getElementById("msg");
    msg.textContent = text || "";
  }

  function formatKpLine(data){
    // data.dates: "DD.MM.YYYY"
    const dates = Array.isArray(data?.dates) ? data.dates.join(" • ") : "";
    const kp = Array.isArray(data?.kp) ? data.kp.join(", ") : "";
    if(!dates && !kp) return "—";
    if(dates && kp) return `${dates} | ${kp}`;
    return dates || kp;
  }

  function kpClass(kp){
    const v = Number(kp);
    if(Number.isNaN(v)) return "";
    if(v <= 3) return "kp0_3";
    if(v === 4) return "kp4";
    if(v === 5) return "kp5";
    if(v === 6) return "kp6";
    if(v === 7) return "kp7";
    return "kp8_9";
  }

  function shortDDMM(dmy){
    // "24.02.2026" -> "24.02"
    if(typeof dmy !== "string") return "";
    const parts = dmy.split(".");
    if(parts.length < 2) return dmy;
    return parts[0] + "." + parts[1];
  }

  function renderKpChips(data){
    const chipsEl = document.getElementById("kp-chips");
    const badgeEl = document.getElementById("kp-badge");
    const badgeDot = document.getElementById("kp-badge-dot");
    const maxEl = document.getElementById("kp-max");

    chipsEl.innerHTML = "";
    badgeEl.style.display = "none";
    maxEl.textContent = "—";
    badgeDot.className = "dot";

    const dates = Array.isArray(data?.dates) ? data.dates : [];
    const kp = Array.isArray(data?.kp) ? data.kp : [];

    const pairs = [];
    for(let i=0;i<Math.max(dates.length, kp.length);i++){
      const di = dates[i];
      const ki = kp[i];
      if(di == null && ki == null) continue;
      pairs.push({ d: di, k: ki });
    }

    if(!pairs.length){
      chipsEl.innerHTML = "<div class='muted'>—</div>";
      return;
    }

    // chips
    pairs.forEach(item => {
      const chip = document.createElement("span");
      chip.className = "kp-chip";

      const tag = document.createElement("span");
      tag.className = "tag " + kpClass(item.k);
      tag.textContent = (item.k == null || item.k === "") ? "—" : String(item.k);

      const t = document.createElement("span");
      t.textContent = shortDDMM(item.d || "");

      chip.appendChild(t);
      chip.appendChild(tag);
      chipsEl.appendChild(chip);
    });

    // max badge
    const nums = pairs.map(x => Number(x.k)).filter(v => !Number.isNaN(v));
    if(nums.length){
      const max = Math.max(...nums);
      maxEl.textContent = String(max);
      badgeDot.classList.add(kpClass(max));
      badgeEl.style.display = "inline-flex";
    }
  }

  function renderDates(list){
    const datesEl = document.getElementById("dates");
    const emptyEl = document.getElementById("empty");
    const countEl = document.getElementById("count");

    datesEl.innerHTML = "";
    emptyEl.style.display = "none";

    if(!list.length){
      countEl.textContent = "Совпадений: 0";
      emptyEl.style.display = "block";
      return;
    }

    countEl.textContent = "Дат: " + list.length;

    list.forEach((d, idx) => {
      const btn = document.createElement("button");
      btn.className = "date-btn";
      btn.textContent = d;
      btn.onclick = () => selectDate(d, btn);
      datesEl.appendChild(btn);

      // Автооткрытие самой свежей даты, если нет поиска
      const q = (document.getElementById("search").value || "").trim();
      if(idx === 0 && !q) setTimeout(() => btn.click(), 0);
    });
  }

  async function selectDate(date, btn){
    document.querySelectorAll(".date-btn").forEach(b => b.classList.remove("active"));
    if(btn){
      btn.classList.add("active");
      // ✅ чтобы выбранная дата всегда была видна
      btn.scrollIntoView({ block: "nearest", behavior: "smooth" });
    }

    const title = document.getElementById("view-title");
    const view  = document.getElementById("view");

    view.style.display = "none";
    view.classList.remove("fade-in");
    setMsg("Загрузка данных за " + date + "…");

    try{
      const j = await fetchJSON(API_ONE(date));
      const data = j.data;

      title.textContent = "Прогноз за " + date;
      document.getElementById("lu").textContent = data.lastUpdate || data.savedAtAlmaty || "—";

      // старую строку оставляем скрытой (на всякий)
      document.getElementById("kp").textContent = formatKpLine(data);

      // ✅ новые чипы + max
      renderKpChips(data);

      document.getElementById("st").textContent = data.statusText || "—";
      document.getElementById("raw").textContent = JSON.stringify(data, null, 2);

      setMsg("");
      view.style.display = "block";

      // ✅ fade in (перезапуск анимации)
      void view.offsetWidth;
      view.classList.add("fade-in");
    }catch(e){
      setMsg("Ошибка: " + (e.message || e));
    }
  }

  function applyFilter(){
    const q = (document.getElementById("search").value || "").trim();
    if(!q){
      renderDates(ALL_DATES.slice());
      return;
    }

    const filtered = ALL_DATES.filter(d => d.includes(q));
    renderDates(filtered);

    // Быстрый переход, если введена точная дата и она есть
    if(filtered.length && filtered[0] === q){
      const btns = Array.from(document.querySelectorAll(".date-btn"));
      const b = btns.find(x => x.textContent === q);
      if(b) b.click();
    }
  }

  async function init(){
    setMsg("Загрузка списка…");
    try{
      const j = await fetchJSON(API_LIST);
      ALL_DATES = Array.isArray(j.dates) ? j.dates : [];
      setMsg("");

      if(!ALL_DATES.length){
        document.getElementById("count").textContent = "Архив пуст. Сохраните прогноз хотя бы один раз.";
        document.getElementById("empty").style.display = "block";
        return;
      }

      renderDates(ALL_DATES.slice());
    }catch(e){
      setMsg("Ошибка загрузки архива: " + (e.message || e));
      document.getElementById("count").textContent = "Ошибка";
    }
  }

  document.getElementById("search").addEventListener("input", applyFilter);

  document.getElementById("btn-clear").addEventListener("click", () => {
    document.getElementById("search").value = "";
    applyFilter();
  });

  init();
</script>
</body>
</html>

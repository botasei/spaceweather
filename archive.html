<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Архив прогнозов — Институт ионосферы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;max-width:1200px}
    h1{margin:0 0 8px}
    .wrap{display:grid;grid-template-columns:280px 1fr;gap:18px;margin-top:14px}
    .list{border:1px solid #ddd;border-radius:12px;padding:10px}
    .list button{
      width:100%; text-align:left; padding:10px 12px; margin:6px 0;
      border-radius:10px; border:1px solid #e5e5e5; background:#fff; cursor:pointer;
      font-size:16px;
    }
    .list button:hover{background:#f6f6f6}
    .list button.active{background:#eef5ff;border-color:#bcd6ff}
    .panel{border:1px solid #ddd;border-radius:12px;padding:14px}
    pre{background:#f6f6f6;padding:12px;border-radius:12px;overflow:auto}
    .muted{color:#666;font-size:14px;margin:0}
    .kpline{font-size:18px;margin:8px 0}
  </style>
</head>
<body>
  <h1>Архив прогнозов</h1>


  <div class="wrap">
    <div class="list">
      <div class="muted" style="margin:6px 6px 10px;">Выбери дату:</div>
      <div id="dates">Загрузка…</div>
    </div>

    <div class="panel">
      <h2 id="title" style="margin-top:0;">Выбери дату слева</h2>
      <div id="view" style="display:none;">
        <div class="kpline"><b>Последнее обновление:</b> <span id="lu"></span></div>
        <div class="kpline"><b>Kp (6 дней):</b> <span id="kp"></span></div>
        <h3>Состояние околоземного космического пространства</h3>
        <div id="st" style="white-space:pre-wrap;line-height:1.6;"></div>

        <details style="margin-top:14px;">
          <summary>Показать сырой JSON</summary>
          <pre id="raw"></pre>
        </details>
      </div>
      <div id="msg" class="muted">—</div>
    </div>
  </div>

<script>
const API_LIST = "/api/archive";
const API_ONE  = (d) => "/api/archive?date=" + encodeURIComponent(d);

function formatDatesFromForecast(data){
  // data.dates у тебя "DD.MM.YYYY"
  return Array.isArray(data?.dates) ? data.dates.join(" • ") : "";
}

async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Request failed");
  return j;
}

async function loadList(){
  const el = document.getElementById("dates");
  const msg = document.getElementById("msg");
  msg.textContent = "Загрузка списка…";

  const j = await fetchJSON(API_LIST);
  const dates = j.dates || [];

  if(!dates.length){
    el.textContent = "Архив пока пуст. Сохрани прогноз хотя бы один раз.";
    msg.textContent = "";
    return;
  }

  el.innerHTML = "";
  msg.textContent = "Всего дат: " + dates.length;

  dates.forEach((d, idx) => {
    const btn = document.createElement("button");
    btn.textContent = d;
    btn.onclick = () => selectDate(d, btn);
    el.appendChild(btn);

    // автоматически открыть самую свежую дату
    if(idx === 0) setTimeout(()=>btn.click(), 0);
  });
}

async function selectDate(date, btn){
  document.querySelectorAll(".list button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");

  const title = document.getElementById("title");
  const view = document.getElementById("view");
  const msg  = document.getElementById("msg");

  msg.textContent = "Загрузка данных за " + date + "…";
  view.style.display = "none";

  try{
    const j = await fetchJSON(API_ONE(date));
    const data = j.data;

    title.textContent = "Прогноз за " + date;
    document.getElementById("lu").textContent = data.lastUpdate || data.savedAtAlmaty || "—";
    document.getElementById("kp").textContent = formatDatesFromForecast(data) + " | " + (data.kp ? data.kp.join(", ") : "");
    document.getElementById("st").textContent = data.statusText || "—";
    document.getElementById("raw").textContent = JSON.stringify(data, null, 2);

    msg.textContent = "";
    view.style.display = "block";
  }catch(e){
    msg.textContent = "Ошибка: " + (e.message || e);
  }
}

loadList().catch(e => {
  document.getElementById("dates").textContent = "Ошибка загрузки списка";
  document.getElementById("msg").textContent = e.message || e;
});
</script>
</body>
</html>
